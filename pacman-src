#!/usr/bin/env bash
if [ ! "$XDG_CACHE_HOME" ]; then
	XDG_CACHE_HOME="$HOME/.cache"
fi
_target_dir="$XDG_CACHE_HOME/pacman-src"
_update=no
_build_only=no
_skipinteg=no
_noconfirm=no
_makepkg_flags="-sci"
# clone the package repo to init the cache
#
function _init_cache() {
	if [ ! -d "$_target_dir" ] && \
		[ ! -d "$_target_dir/packages" ]
	then
		mkdir -p "$_target_dir"
		echo -e "\n==> Cloning packages repo\n"
		git clone git://git.archlinux.org/svntogit/packages.git --depth=1 "$_target_dir/packages"
	fi
}
# Update the cache
#
function _update_cache() {
	if [ "$_update" = "yes" ]
	then
		cd "$_target_dir/packages"
		echo -e "\n==> Updating packages repo\n"
		git pull origin
	fi
}
#
# Update symlinks
function _update_symlinks() {
	if [ "$_update" = "yes" ]
	then
		echo -e "\n==> Updating symlinks\n"
		for package in $(find "$_target_dir/packages/" -name "PKGBUILD" 2> /dev/null) 
		do 
			source $package 2>/dev/null 
			for item in ${pkgname[@]}
			do 
				if [ ! -d "$_target_dir/packages/$item" ]
	       			then 
					ln -s "$_target_dir/packages/$package" "$_target_dir/packages/$item" 
				fi
       			done
		done
	fi
}
# Start the build using makepkg
#
function _start_build () {
	if [ "$_skipinteg" = "yes" ]
	then
		_makepkg_flags+=" --skipinteg"
	fi
	if [ "$_noconfirm" = "yes" ]
	then
		_makepkg_flags+=" --noconfirm"
	fi
	if [ -d  "$_target_dir/packages/$1" ]
	then
		cd "$_target_dir/packages/$1/trunk"
		if makepkg $_makepkg_flags
		then
			if [ "$_build_only" = "yes" ]
			then
				if [ ! -d "$_target_dir/build" ]
				then
					mkdir -p "$_target_dir/build"
				fi
				cp *.pkg.* "$_target_dir/build/"
			fi
		else
			echo -e "\n==> Build failed!\n"
			exit 1
		fi
	else
		echo -e "\n==> Invalid package!\n"
		exit 1
	fi
}
_init_cache
for item in $@	
do
	case $item in
		--build |-b)  _makepkg_flags="-sc"; _build_only=yes;;
		--update|-u)  _update=yes	  	    	   ;;
		--skipchecks|-s) _skipinteg="yes";;
		--noconfirm|-n)	_noconfirm="yes";;
		--help  |-h) 
			echo "$0 [package]			| Builds and installs the package"
			echo "$0 [--update/-u]		| Updates the cache		 "
			echo "$0 [--build/-b]		| Build-only, no installing	 "
			echo "$0 [--skipchecks|-s]		| Skips any integrity check"
			echo "$0 [--noconfirm|-n]		| No confirmation"
			;;
		*) _packages+="$item"
	esac
done
_update_cache
_update_symlinks
for package in $_packages
do
	echo -e "\n==> Building $package\n"
	_start_build "$package"
done
